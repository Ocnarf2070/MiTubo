CREATE SEQUENCE INC_ID_NOTIF
INCREMENT BY 1
START WITH 1
NOMAXVALUE
NOMINVALUE;

CREATE SEQUENCE INC_ID_VIDEO
INCREMENT BY 1
START WITH 1
NOMAXVALUE
NOMINVALUE;

/*
Para borrar por ejemplo el de notificaciones:
DROP SEQUENCE inc_id_notif;
*/

CREATE OR REPLACE PROCEDURE ALTA_VIDEO 
(
DUR IN NUMBER,
TIT IN VARCHAR2,
DES IN VARCHAR2,
FRM IN VARCHAR2,
ENL IN VARCHAR2,
IMG IN BLOB,
COSTE IN NUMBER
)AS 
IDC NUMBER;
IDU NUMBER;
IDV NUMBER;
IDN NUMBER;
BEGIN
  SELECT ID_USUARIO INTO IDU FROM USUARIO WHERE ALIAS = USER;
  SELECT CANAL_ID_CANAL INTO IDC FROM USUARIO WHERE ALIAS = USER;
  IDV  := INC_ID_VIDEO.NEXTVAL;
  /*SELECT MAX(ID_VIDEO) INTO IDV FROM VIDEO;
  
  IF IDV IS NULL THEN 
    IDV := 1;
  ELSE
    IDV := 1 + IDV;
  END IF;
  */
  IF COSTE = 0 THEN
    INSERT INTO VIDEO (ID_VIDEO, DURACION, TITULO, DESCRIPCION, FORMATO, ENLACE,
    N_VISUALIZACIONES, N_COMENTARIOS, N_MEGUSTA, N_NOMEGUSTA, FECHA_CREACION,
    IMAGEN, VIDEO_PAGO, CANAL_ID_CANAL)
    VALUES(IDV, DUR, TIT, DES, FRM, ENL, 0, 0, 0, 0, SYSDATE, IMG, '0', IDC);
  ELSE
    INSERT INTO VIDEO (ID_VIDEO, DURACION, TITULO, DESCRIPCION, FORMATO, ENLACE,
    N_VISUALIZACIONES, N_COMENTARIOS, N_MEGUSTA, N_NOMEGUSTA, FECHA_CREACION,
    IMAGEN, VIDEO_PAGO, CANAL_ID_CANAL)
    VALUES(IDV, DUR, TIT, DES, FRM, ENL, 0, 0, 0, 0, SYSDATE, IMG, '1', IDC);
    INSERT INTO VIDEO_PAGO (ID_VIDEO, COSTE) VALUES(IDV, COSTE);
  END IF;
  IDN := INC_ID_NOTIF.NEXTVAL;
  /*
  SELECT MAX(ID_NOTIFICACION) INTO IDN FROM NOTIFICACION;
  
  IF IDN IS NULL THEN
    IDN := 1;
  ELSE
    IDN := 1 + IDN;
  END IF;
  */
  
  DECLARE CURSOR U_SUSCRITOS IS SELECT USUARIO_ID_USUARIO FROM SUBSCRIPCIONES WHERE CANAL_ID_CANAL = IDC;
  BEGIN
    FOR VAR_CURSOR IN U_SUSCRITOS LOOP
      INSERT INTO NOTIFICACION (ID_NOTIFICACION, TEXTO, CANAL_ID_CANAL,
      DENUNCIA_ID_DENUNCIA, VIDEO_ID_VIDEO, USUARIO_ID_USUARIO)
      VALUES (IDN, 'Nuevo vídeo: ' || TIT, IDC, NULL, IDV, VAR_CURSOR.USUARIO_ID_USUARIO);
      IDN := IDN + 1;
    END LOOP;
  END;
  COMMIT;
END ALTA_VIDEO;
